#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start CUPS 3.0 Sharing Server (cups-sharing)
# New Architecture: libcups v3 + PAPPL + cups-sharing
# ==============================================================================

bashio::log.info "Starting CUPS 3.0 Sharing Server (Experimental)..."

# Get configuration values
admin_user=$(bashio::config 'admin_user')
admin_password=$(bashio::config 'admin_password')
log_level=$(bashio::config 'log_level')
share_printers=$(bashio::config 'share_printers')
browsing=$(bashio::config 'browsing')
allow_remote_admin=$(bashio::config 'allow_remote_admin')

# New enhanced options
enable_ipps=$(bashio::config 'enable_ipps')
ssl_cert=$(bashio::config 'ssl_cert')
ssl_key=$(bashio::config 'ssl_key')
require_encryption=$(bashio::config 'require_encryption')
max_jobs=$(bashio::config 'max_jobs')
debug_logging=$(bashio::config 'debug_logging')
auto_backup=$(bashio::config 'auto_backup')

# Set log level for PAPPL-based server
case "${log_level}" in
    debug) LOG_LEVEL="debug" ;;
    info) LOG_LEVEL="info" ;;
    warning) LOG_LEVEL="warn" ;;
    error) LOG_LEVEL="error" ;;
    *) LOG_LEVEL="info" ;;
esac

# Override with debug if enabled
if bashio::config.true 'debug_logging'; then
    LOG_LEVEL="debug"
fi

bashio::log.info "Setting up CUPS 3.0 environment..."

# Ensure LD_LIBRARY_PATH is set for locally built libraries
export LD_LIBRARY_PATH=/usr/local/lib:${LD_LIBRARY_PATH:-}
export PATH=/usr/local/bin:/usr/local/sbin:${PATH}

# Create admin user if it doesn't exist
if ! id "${admin_user}" &>/dev/null; then
    bashio::log.info "Creating CUPS admin user: ${admin_user}"
    adduser -D -H -s /sbin/nologin "${admin_user}"
    echo "${admin_user}:${admin_password}" | chpasswd
    addgroup lpadmin 2>/dev/null || true
    addgroup "${admin_user}" lpadmin 2>/dev/null || true
fi

# Ensure directories exist
mkdir -p /var/cache/cups
mkdir -p /var/spool/cups/tmp
mkdir -p /var/run/cups
mkdir -p /etc/cups
mkdir -p /config/cups-backups

# Set permissions
chown -R root:lpadmin /etc/cups 2>/dev/null || chown -R root:root /etc/cups
chmod 755 /etc/cups

# Run initial backup if enabled
if bashio::config.true 'auto_backup'; then
    bashio::log.info "Running initial backup..."
    /usr/local/bin/cups-backup auto 2>/dev/null &
fi

# Configuration summary
bashio::log.info "=== CUPS 3.0 Sharing Server Configuration ==="
bashio::log.info "Architecture: libcups v3 + PAPPL + cups-sharing"
bashio::log.info "Admin User: ${admin_user}"
bashio::log.info "WebUI: http://homeassistant.local:631"
bashio::log.info "Log Level: ${log_level}"
bashio::log.info "Share Printers: ${share_printers}"
bashio::log.info "Browsing: ${browsing}"
bashio::log.info "IPPS: ${enable_ipps}"
bashio::log.info "Auto Discovery: $(bashio::config 'auto_discovery')"
bashio::log.info "=============================================="

# Build command line options for cups-sharing
# PAPPL-based servers typically use these options
CUPS_SHARING_OPTS=""

# Check if cups-sharing binary exists
if [ -x /usr/local/sbin/cups-sharing ]; then
    bashio::log.info "Found cups-sharing at /usr/local/sbin/cups-sharing"
    CUPS_SHARING_BIN="/usr/local/sbin/cups-sharing"
elif [ -x /usr/local/bin/cups-sharing ]; then
    bashio::log.info "Found cups-sharing at /usr/local/bin/cups-sharing"
    CUPS_SHARING_BIN="/usr/local/bin/cups-sharing"
else
    # List available binaries for debugging
    bashio::log.warning "cups-sharing binary not found in expected locations"
    bashio::log.info "Available binaries in /usr/local/sbin:"
    ls -la /usr/local/sbin/ 2>/dev/null || echo "Directory not found"
    bashio::log.info "Available binaries in /usr/local/bin:"
    ls -la /usr/local/bin/ 2>/dev/null || echo "Directory not found"

    # Try to find any cups-related binary
    CUPS_SHARING_BIN=$(find /usr/local -name "cups-sharing*" -type f -executable 2>/dev/null | head -1)

    if [ -z "${CUPS_SHARING_BIN}" ]; then
        bashio::log.error "CUPS 3.0 Sharing Server binary not found!"
        bashio::log.error "This is an experimental build - the project may still be in development"
        bashio::log.info "Sleeping to allow container inspection..."
        exec sleep infinity
    fi
fi

bashio::log.info "Starting CUPS Sharing Server: ${CUPS_SHARING_BIN}"

# Start cups-sharing in foreground
# Note: Command line options may vary as CUPS 3.0 is in alpha stage
exec "${CUPS_SHARING_BIN}" ${CUPS_SHARING_OPTS}
