#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start CUPS daemon
# ==============================================================================
declare admin_user
declare admin_password
declare log_level
declare share_printers
declare browsing
declare allow_remote_admin

bashio::log.info "Starting CUPS 3 (OpenPrinting)..."

# Get configuration
admin_user=$(bashio::config 'admin_user')
admin_password=$(bashio::config 'admin_password')
log_level=$(bashio::config 'log_level')
share_printers=$(bashio::config 'share_printers')
browsing=$(bashio::config 'browsing')
allow_remote_admin=$(bashio::config 'allow_remote_admin')

# Set log level
case "${log_level}" in
    debug)
        LOG_LEVEL="debug2"
        ;;
    info)
        LOG_LEVEL="info"
        ;;
    warning)
        LOG_LEVEL="warn"
        ;;
    error)
        LOG_LEVEL="error"
        ;;
    *)
        LOG_LEVEL="info"
        ;;
esac

bashio::log.info "Setting up CUPS configuration..."

# Show CUPS version
bashio::log.info "CUPS Version: $(cupsd --version 2>&1 || echo 'Version check failed')"

# Create cupsd.conf
cat > /etc/cups/cupsd.conf <<EOFCONF
# CUPS Configuration File
# Generated by Home Assistant Add-on
# Built from OpenPrinting CUPS source

LogLevel ${LOG_LEVEL}
MaxLogSize 0
ErrorLog stderr
AccessLog stderr
PageLog stderr

# Listen on all interfaces
Listen 0.0.0.0:631
ServerAlias *

# Server settings
ServerName $(hostname)
DefaultEncryption Never
ServerTokens Minimal

# Browsing
Browsing $(bashio::var.true "${browsing}" && echo "On" || echo "Off")
BrowseLocalProtocols dnssd

# Share printers
DefaultShared $(bashio::var.true "${share_printers}" && echo "Yes" || echo "No")

# Allow remote administration
<Location />
  Order allow,deny
  $(bashio::var.true "${allow_remote_admin}" && echo "Allow all" || echo "Allow @LOCAL")
</Location>

<Location /admin>
  Order allow,deny
  $(bashio::var.true "${allow_remote_admin}" && echo "Allow all" || echo "Allow @LOCAL")
</Location>

<Location /admin/conf>
  AuthType Default
  Require user @SYSTEM
  Order allow,deny
  $(bashio::var.true "${allow_remote_admin}" && echo "Allow all" || echo "Allow @LOCAL")
</Location>

# IPP Everywhere support
<Policy default>
  <Limit All>
    Order deny,allow
  </Limit>
</Policy>
EOFCONF

# Create admin user if it doesn't exist
if ! id "${admin_user}" &>/dev/null; then
    bashio::log.info "Creating CUPS admin user: ${admin_user}"
    adduser -D -H -s /sbin/nologin "${admin_user}"
    echo "${admin_user}:${admin_password}" | chpasswd
    addgroup "${admin_user}" lpadmin 2>/dev/null || addgroup lpadmin && addgroup "${admin_user}" lpadmin
fi

# Ensure directories exist
mkdir -p /var/cache/cups
mkdir -p /var/spool/cups/tmp
mkdir -p /var/run/cups

# Set permissions
chown -R root:lpadmin /etc/cups 2>/dev/null || chown -R root:root /etc/cups
chmod 755 /etc/cups
chmod 640 /etc/cups/cupsd.conf

bashio::log.info "CUPS configuration complete"
bashio::log.info "WebUI available at: http://homeassistant.local:631"
bashio::log.info "Admin user: ${admin_user}"

# Start CUPS in foreground
exec /usr/sbin/cupsd -f
